# FiND (Fingerprint-based Neighbor Discovery)

设备感知时延大是万场互联应用的痛点。FiND(Fingerprint-based Neighbor Discovery) 采用指纹进行快速发现，能够在干扰情况下，降低设备感知尾时延。同时，通过FiND pro中的指纹定位模块，通过机器学习的方法，实现指纹定位技术，提升信标发现的准确度。最终实现又快又准。

\Android 主要用于验证FiND, 手动/自动收集数据，验证FiND pro。

\FingerprintPositioningML 用于数据预处理、模型训练和验证。

## 运行环境

Android Studio: 安卓程序开发环境，用于编译Android apk。
Spyder(Scientific PYthon Development EnviRonment)：Python 语言开发环境。

## 数据格式说明

* PHONEID：扫描设备的型号，例如 TAS-AL00
* LONGITUDE: 经度，取值范围-7695.9387549299299000 到 -7299.786516730871000
* LATITUDE: 纬度，取值范围4864745.7450159714 到 4865017.3646842018
* CITYID: 所在城市的ID，大于等于0的整数
* BUILDINGID: 所在建筑的ID，大于等于0的整数
* FLOOR: 所在楼层，整数
* BEACONID: 目标广播设备（如信标）标识符，字符串
* SPACEID：所在空间（如商铺）的ID，大于等于0的整数
* DISTANCERANGE：扫描设备与目标广播设备之间的相对距离范围，整数（0：近（1米内），1：较近（1-3米），2：远（大于3米））
* TIMESTAMP：时间戳，取UNIX时间格式，整数
* MAC001：周边广播设备（如Wi-Fi AP）MAC001的信号强度，取值范围-104 到 0。如果未检测到设备MAC001，则信号强度为+100. 
* ...
* MAC020：周边广播设备（如Wi-Fi AP）MAC020的信号强度，取值范围-104 到 0。如果未检测到设备MAC020，则信号强度为+100. 
* ...

> 注意：模板列出20个MAC，其中，MAC001 - MAC020根据广播设备标识符（MAC地址）进行排序得到。实际的MAC总数应该等于针对某个目标广播设备周边的所有其它广播设备数目的和，这个值可能远大于20。

## 跨平台模型部署

PMML是数据挖掘的一种通用的规范，它用统一的XML格式来描述我们生成的机器学习模型。这样无论你的模型是sklearn,R还是Spark MLlib生成的，我们都可以将其转化为标准的XML格式来存储。当我们需要将这个PMML的模型用于部署的时候，可以使用目标环境的解析PMML模型的库来加载模型，并做预测。可以看出，要使用PMML，需要两步的工作，第一块是将离线训练得到的模型转化为PMML模型文件，第二块是将PMML模型文件载入在线预测环境，进行预测。

将pmml序列化成ser，并在安卓中部署ser的过程，请参考\FingerprintPositioningML\README.md.

## 标签输出

* 近（Immediate = 1): Distance Range = 1 m

* 较近（Near = 2）: Distance Range = 1-3 m

* 远（Far = 3）: Distance Range > 3 m

## FAQ

Q1: 为什么采用Wi-Fi热点作为指纹？

A1: 蓝牙信标感知尾时延大的根因是无线干扰。低功耗蓝牙信标在蓝牙标准规定的编号为37、38、39的三个频道上进行广播和扫描。因此，多个低功耗蓝牙信标之间存在干扰。这种干扰存在随机性，使得最坏情况下蓝牙信标感知时延大。采用Wi-Fi热点作为指纹，一方面，Wi-Fi不会工作在编号为37，39的频道上，因此与低功耗蓝牙信标产生干扰的可能性小；另一方面，Wi-Fi热点是最普遍部署的现成的设施，通过Wi-Fi信号作为环境指纹关联蓝牙信标设备标识符，扫描设备即使无法即时扫描到蓝牙信标设备标识符，也总是能扫描到周边环境的部分Wi-Fi信号，扫描设备可以根据这些Wi-Fi信号生成的环境指纹，推断出蓝牙信标是否在周边。

Q2: FiND基于Wi-Fi指纹，什么时候触发Wi-Fi扫描获取指纹数据？

A2: 扫描管理模块基于特定事件触发启动Wi-Fi扫描。特定事件也可以是设备亮屏、超时或者设备运动状态变化等。同时，由于系统会周期性地进行Wi-Fi扫描，并将扫描到的热点列表结果存储在系统的缓存里，因此，当历史数据未老化时，可不进行Wi-Fi扫描，只有当历史数据已老化时才启动Wi-Fi扫描。

Q3: 环境中Wi-Fi热点可能动态变化，如何保证系统的鲁棒性？

A3: 云侧会统计每个热点的上报次数（计数），更新指纹时会参考上报次数进行排序，选取其中的前K个。如果某个热点是固定位置的、非临时生成的，则其上报次数大概率大于那些临时生成的、非固定位置的热点。

Q4: FiND与传统的室内指纹定位技术的区别和联系是什么？

A4: FiND的目标是快速感知设备，而不需要知道设备的具体位置。信号强度RSS仅用于对热点进行排序，对设备差异性引入的误差不敏感。
FiND和传统的室内指纹定位技术相同点是，都用到了Wi-Fi热点作为指纹，但目标不同，而且FiND实施难度更小。后面讲到的FiND pro，则是在FiND的基础上，增加轻量级、自标注的室内指纹定位技术，从而提高感知准确性。


